{{- if .Values.dsp.enabled }}
{{- range $name, $deployment := .Values.dsp.deployment }}

{{- $cfg := mergeOverwrite (deepCopy $.Values.dsp.common) $deployment }}

---
apiVersion: v1
kind: Service
metadata:
  name: dsp-controlplane-{{ $name }}
  namespace: {{ $.Release.Namespace | quote }}

  {{- with $cfg.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  labels:
    app.kubernetes.io/name: dsp-controlplane
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/component: {{ $name }}

spec:
  type: {{ $cfg.service.type }}

  ports:
    - name: http
      port: {{ $cfg.config.web.http.port }}
      targetPort: http
      protocol: TCP

    - name: http-version
      port: {{ $cfg.config.web.http.version.port }}
      targetPort: http-version
      protocol: TCP

    - name: http-protocol
      port: {{ $cfg.config.web.http.protocol.port }}
      targetPort: http-protocol
      protocol: TCP

    - name: http-catalog
      port: {{ $cfg.config.web.http.catalog.port }}
      targetPort: http-catalog
      protocol: TCP

    - name: http-management
      port: {{ $cfg.config.web.http.management.port }}
      targetPort: http-management
      protocol: TCP

    - name: http-control
      port: {{ $cfg.config.web.http.control.port }}
      targetPort: http-control
      protocol: TCP

    - name: http-tck
      port: {{ $cfg.config.testExtension.controller.port }}
      targetPort: http-tck
      protocol: TCP

  selector:
    app.kubernetes.io/name: dsp-controlplane
    app.kubernetes.io/component: {{ $name }}

{{- end }}
{{- end }}